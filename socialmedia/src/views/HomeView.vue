<script setup>
import { ref } from 'vue';
import axios from 'axios';
import { useUserStore } from '@/stores/counter';
import { useToast } from 'vue-toast-notification';
import router from '@/router';

const toast = useToast();
const username = ref('');
const password = ref('');
const usernameEl = ref(null);
const passwordEl = ref(null);
const SignUpButton = ref(null);
const SignInButton = ref(null);
const userStore = useUserStore();

async function SignIn(){
  SignInButton.value.disabled = true;
  SignUpButton.value.disabled = true;

  let userinput = username.value.trim();
  let passwInput = password.value.trim();
  if (!userinput) {
    usernameEl.value.classList.add('error');
    toast.error("Invalid username!", {duration: 5000})
    SignInButton.value.disabled = false;
    SignUpButton.value.disabled = false;
    return
  }
  
  usernameEl.value.classList.remove('error');
  if (!passwInput) {
    passwordEl.value.classList.add('error');
    toast.error("Invalid password!")
    SignInButton.value.disabled = false;
    SignUpButton.value.disabled = false;
    return
  }
  if (passwInput.includes(" ")) {
    passwordEl.value.classList.add('error');
    toast.error("Password contains spaces")
    SignInButton.value.disabled = false;
    SignUpButton.value.disabled = false;
    return
  }

  passwordEl.value.classList.remove('error');
  let fetch = await axios.get("http://localhost:3000/users");
  let users = fetch.data;
  let user;
  if (userinput.includes("@")) {
    user = users.find(user => user.email === userinput && user.password === passwInput);
  }
  else{
    user = users.find(user => user.username === userinput && user.password === passwInput);
  }

  if (!user) {
    username.value = '';
    password.value = '';
    toast.error("Invalid username or password!")
    SignInButton.value.disabled = false;
    SignUpButton.value.disabled = false;
  }
  else{
    toast.success("Logged in successfully! Redirecting...")
    userStore.id = user.id;
    userStore.username = user.username;
    userStore.email = user.email;
    userStore.password = user.password;
    userStore.displayname = user.displayname;
    setTimeout(() => {
      router.push({name: 'feed'})
    }, 2000);
  }

}


</script>

<template>

  <div class="login-wrapper">
    <div class="login">
      <div class="logo">
        <svg width="149" height="168" viewBox="0 0 149 168" fill="none" xmlns="http://www.w3.org/2000/svg">
<ellipse cx="73.5" cy="82" rx="44.5" ry="44" fill="#00A4FF"/>
<path d="M94.9544 90.0754C95.5483 90.6529 96.4979 90.6396 97.0755 90.0457L106.487 80.367C107.064 79.7731 107.051 78.8234 106.457 78.2459C105.863 77.6683 104.914 77.6816 104.336 78.2756L95.9704 86.8788L87.3671 78.5132C86.7732 77.9357 85.8235 77.949 85.246 78.5429C84.6685 79.1368 84.6818 80.0865 85.2757 80.664L94.9544 90.0754ZM57.8256 68.2524C67.4846 61.886 76.542 60.7961 83.1038 64.1656C89.641 67.5224 94.3126 75.6244 94.5002 89.021L97.4999 88.979C97.304 74.9894 92.3859 65.5595 84.4742 61.4968C76.5869 57.4468 66.3361 59.05 56.1746 65.7475L57.8256 68.2524Z" fill="white" fill-opacity="0.99"/>
<path d="M53.4596 75.9351C52.8715 75.3517 51.9217 75.3555 51.3383 75.9436L41.8307 85.5277C41.2473 86.1159 41.2511 87.0656 41.8392 87.649C42.4274 88.2325 43.3771 88.2287 43.9605 87.6405L52.4117 79.1213L60.931 87.5725C61.5191 88.1559 62.4688 88.1521 63.0523 87.564C63.6357 86.9758 63.6319 86.0261 63.0438 85.4427L53.4596 75.9351ZM90.3685 98.128C80.6463 104.398 71.5784 105.397 65.0507 101.962C58.5473 98.54 53.9569 90.3917 53.9032 76.994L50.9032 77.006C50.9593 90.9968 55.7829 100.475 63.6537 104.617C71.5001 108.746 81.7664 107.245 91.9944 100.649L90.3685 98.128Z" fill="white" fill-opacity="0.99"/>
<path d="M86 14C78.6473 16.8609 76.4851 19.8068 74 26C71.8925 19.6313 69.1717 17.0649 62 14C68.901 11.0577 71.8791 8.70641 74 2C76.8206 9.20875 79.5977 11.6338 86 14Z" fill="#00A4FF" stroke="#00A4FF"/>
<path d="M106 26C101.711 27.6689 100.45 29.3873 99 33C97.7706 29.2849 96.1835 27.7879 92 26C96.0256 24.2837 97.7628 22.9121 99 19C100.645 23.2051 102.265 24.6197 106 26Z" fill="#00A4FF" stroke="#00A4FF"/>
<path d="M56 26C51.7109 27.6689 50.4496 29.3873 49 33C47.7706 29.2849 46.1835 27.7879 42 26C46.0256 24.2837 47.7628 22.9121 49 19C50.6453 23.2051 52.2653 24.6197 56 26Z" fill="#00A4FF" stroke="#00A4FF"/>
<path d="M20.9524 129.721C20.4122 130.382 19.7922 130.814 19.0924 131.016C18.401 131.209 17.6547 131.184 16.8535 130.942C16.0626 130.709 15.2646 130.263 14.4596 129.605C14.0467 129.267 13.6663 128.921 13.3181 128.568C12.9803 128.223 12.6861 127.887 12.4356 127.562C12.1935 127.226 12.0002 126.904 11.8556 126.597L12.9445 125.265C13.181 125.734 13.5179 126.26 13.9552 126.841C14.4028 127.431 14.9208 127.967 15.5091 128.448C16.0561 128.895 16.5745 129.198 17.0643 129.358C17.554 129.517 18.0015 129.539 18.4067 129.422C18.812 129.306 19.1623 129.067 19.4578 128.706C19.7532 128.345 19.9248 127.977 19.9725 127.602C20.0203 127.228 19.9377 126.782 19.7246 126.263C19.5303 125.742 19.1948 125.089 18.718 124.303C18.3867 123.739 18.1207 123.211 17.9198 122.72C17.7377 122.227 17.6334 121.754 17.6071 121.302C17.5807 120.849 17.6407 120.407 17.7869 119.976C17.9435 119.553 18.199 119.124 18.5536 118.691C19.0347 118.103 19.5937 117.724 20.2307 117.556C20.8761 117.378 21.5548 117.391 22.2669 117.594C22.9893 117.806 23.6963 118.195 24.3878 118.76C24.9968 119.258 25.5077 119.771 25.9206 120.298C26.3335 120.825 26.6704 121.35 26.9313 121.874L25.5229 122.711C25.276 122.234 24.972 121.753 24.6107 121.268C24.2597 120.791 23.8417 120.355 23.3566 119.958C22.8921 119.578 22.4502 119.329 22.0308 119.209C21.6115 119.09 21.2231 119.091 20.8657 119.213C20.5167 119.323 20.2114 119.539 19.9497 119.859C19.6459 120.23 19.4701 120.603 19.4223 120.977C19.3745 121.352 19.4459 121.781 19.6365 122.264C19.827 122.747 20.1288 123.347 20.5417 124.063C20.9978 124.832 21.3338 125.538 21.5497 126.179C21.7844 126.819 21.8591 127.423 21.7738 127.99C21.6989 128.566 21.4251 129.143 20.9524 129.721Z" fill="#00A4FF"/>
<path d="M35.0197 136.427C34.5772 137.203 34.08 137.833 33.5281 138.316C32.9944 138.795 32.4175 139.134 31.7976 139.333C31.1892 139.538 30.55 139.596 29.8801 139.506C29.2285 139.41 28.5725 139.174 27.9123 138.798C27.2984 138.448 26.7902 138.02 26.3879 137.514C25.9921 136.997 25.722 136.421 25.5775 135.786C25.433 135.151 25.4191 134.476 25.5359 133.76C25.6708 133.038 25.9595 132.29 26.4019 131.514C26.9897 130.483 27.6587 129.713 28.4091 129.205C29.166 128.685 29.9745 128.424 30.8344 128.423C31.701 128.411 32.5803 128.659 33.4721 129.168C34.3177 129.65 34.95 130.263 35.3692 131.009C35.8065 131.749 36 132.581 35.9496 133.504C35.9174 134.422 35.6074 135.396 35.0197 136.427ZM27.983 132.415C27.567 133.145 27.2964 133.835 27.1713 134.485C27.0645 135.13 27.1312 135.713 27.3715 136.234C27.6118 136.754 28.0447 137.193 28.6702 137.549C29.2956 137.906 29.8936 138.055 30.4641 137.997C31.0346 137.938 31.5644 137.696 32.0536 137.268C32.5609 136.836 33.0225 136.255 33.4386 135.526C33.8612 134.784 34.1227 134.097 34.223 133.463C34.3232 132.83 34.2499 132.259 34.003 131.749C33.7743 131.235 33.3414 130.797 32.7043 130.433C31.7545 129.892 30.8871 129.812 30.1019 130.193C29.3167 130.574 28.6104 131.315 27.983 132.415Z" fill="#00A4FF"/>
<path d="M42.6457 145.504C41.7584 145.174 41.0324 144.697 40.4674 144.074C39.915 143.456 39.5807 142.692 39.4645 141.781C39.3607 140.874 39.5298 139.827 39.9715 138.64C40.4319 137.403 41.0124 136.474 41.7131 135.853C42.4138 135.231 43.1814 134.87 44.0161 134.768C44.8632 134.67 45.7366 134.789 46.6364 135.124C47.1487 135.315 47.6214 135.554 48.0544 135.844C48.492 136.12 48.8329 136.389 49.077 136.651L48.0617 137.831C47.8037 137.607 47.4933 137.37 47.1306 137.122C46.768 136.873 46.4117 136.683 46.0618 136.553C45.387 136.302 44.7774 136.239 44.2331 136.364C43.6888 136.488 43.2058 136.792 42.7841 137.275C42.3624 137.759 41.9958 138.419 41.6842 139.256C41.3866 140.056 41.2394 140.777 41.2426 141.418C41.2458 142.059 41.4063 142.603 41.7242 143.048C42.0421 143.494 42.5197 143.835 43.157 144.072C43.7069 144.277 44.2089 144.4 44.6631 144.441C45.1298 144.486 45.5684 144.493 45.9787 144.461L45.4347 145.923C45.0322 145.972 44.6084 145.964 44.1635 145.898C43.7264 145.849 43.2205 145.718 42.6457 145.504Z" fill="#00A4FF"/>
<path d="M56.2891 138.054L53.8796 148.5L52.1647 148.104L54.5742 137.658L56.2891 138.054ZM56.3547 133.944C56.6146 134.003 56.8209 134.147 56.9739 134.374C57.1428 134.591 57.1838 134.887 57.0969 135.264C57.013 135.628 56.8461 135.877 56.5963 136.011C56.3594 136.148 56.1111 136.186 55.8512 136.126C55.5654 136.06 55.346 135.914 55.1931 135.687C55.0402 135.46 55.0057 135.165 55.0896 134.801C55.1765 134.424 55.3369 134.174 55.5707 134.05C55.8076 133.913 56.0689 133.878 56.3547 133.944Z" fill="#00A4FF"/>
<path d="M67.1402 139.498C68.442 139.611 69.3803 139.98 69.9552 140.605C70.5301 141.23 70.7634 142.167 70.6553 143.416L70.0257 150.689L68.7504 150.578L68.5428 149.035L68.4631 149.028C68.1242 149.387 67.7772 149.684 67.4222 149.921C67.0815 150.146 66.6935 150.3 66.258 150.383C65.8359 150.467 65.3259 150.483 64.7282 150.431C64.0905 150.376 63.5225 150.213 63.024 149.942C62.5387 149.673 62.1701 149.293 61.9182 148.802C61.6673 148.299 61.5729 147.688 61.6351 146.971C61.7271 145.908 62.2162 145.128 63.1025 144.629C63.99 144.117 65.3061 143.91 67.0509 144.007L68.8693 144.104L68.9245 143.467C69.0015 142.577 68.8624 141.942 68.5071 141.564C68.1518 141.185 67.6221 140.965 66.9181 140.904C66.3601 140.856 65.8213 140.896 65.3016 141.025C64.783 141.141 64.2953 141.286 63.8386 141.461L63.4145 140.099C63.9012 139.887 64.4709 139.722 65.1235 139.605C65.7772 139.474 66.4494 139.438 67.1402 139.498ZM67.1648 145.242C65.8319 145.18 64.8903 145.312 64.34 145.64C63.803 145.968 63.5052 146.471 63.4465 147.148C63.3948 147.746 63.5362 148.2 63.8707 148.51C64.2185 148.821 64.678 149.001 65.2492 149.051C66.1524 149.129 66.9242 148.948 67.5646 148.508C68.206 148.055 68.5716 147.311 68.6613 146.275L68.7441 145.318L67.1648 145.242Z" fill="#00A4FF"/>
<path d="M80.0554 150.496L78.298 150.591L77.4779 135.413L79.2354 135.319L80.0554 150.496Z" fill="#00A4FF"/>
<path d="M95.8889 144.317C96.0491 145.155 95.9826 145.907 95.6893 146.574C95.3935 147.228 94.8959 147.785 94.1964 148.245C93.51 148.702 92.6561 149.028 91.6346 149.223C91.1107 149.323 90.6015 149.393 90.107 149.434C89.6255 149.471 89.1795 149.482 88.7691 149.465C88.3562 149.436 87.9854 149.378 87.6566 149.291L87.3336 147.602C87.8451 147.721 88.4642 147.8 89.1909 147.837C89.9306 147.872 90.6737 147.818 91.4202 147.676C92.1143 147.543 92.6795 147.34 93.1159 147.066C93.5523 146.793 93.8559 146.463 94.0265 146.078C94.1971 145.692 94.2386 145.27 94.151 144.812C94.0633 144.354 93.8912 143.986 93.6347 143.709C93.3782 143.433 92.9826 143.21 92.4479 143.04C91.9239 142.855 91.2075 142.694 90.2986 142.555C89.6536 142.448 89.0782 142.314 88.5722 142.152C88.0769 141.976 87.6473 141.752 87.2835 141.482C86.9197 141.213 86.6191 140.883 86.3819 140.494C86.1577 140.103 85.993 139.632 85.8878 139.082C85.7451 138.335 85.8136 137.664 86.0932 137.067C86.3703 136.458 86.8153 135.945 87.4281 135.529C88.054 135.111 88.8057 134.818 89.6831 134.65C90.4558 134.503 91.1767 134.439 91.846 134.461C92.5152 134.482 93.1343 134.561 93.7032 134.696L93.4424 136.314C92.9178 136.197 92.3536 136.122 91.7498 136.088C91.1592 136.051 90.5561 136.092 89.9405 136.21C89.3512 136.322 88.8764 136.501 88.5161 136.747C88.1557 136.992 87.9074 137.291 87.771 137.643C87.6322 137.981 87.6016 138.354 87.6792 138.76C87.7693 139.231 87.9427 139.605 88.1992 139.882C88.4558 140.159 88.8304 140.379 89.3233 140.543C89.8161 140.706 90.4699 140.86 91.2845 141.003C92.1672 141.146 92.9239 141.341 93.5546 141.587C94.196 141.817 94.707 142.147 95.0878 142.576C95.4816 143.003 95.7487 143.583 95.8889 144.317Z" fill="#00A4FF"/>
<path d="M97.9232 136.613L99.6887 135.967L103.964 140.898C104.213 141.19 104.445 141.475 104.659 141.751C104.887 142.023 105.099 142.293 105.297 142.561C105.49 142.817 105.662 143.074 105.813 143.331L105.888 143.303C105.848 142.963 105.818 142.512 105.798 141.952C105.773 141.379 105.754 140.804 105.741 140.226L105.699 133.767L107.483 133.114L107.338 146.159C107.329 146.872 107.246 147.52 107.09 148.102C106.952 148.693 106.696 149.198 106.325 149.618C105.97 150.046 105.467 150.379 104.816 150.617C104.516 150.727 104.246 150.805 104.007 150.85C103.772 150.907 103.567 150.947 103.39 150.969L102.909 149.654C103.056 149.629 103.228 149.594 103.425 149.551C103.634 149.502 103.846 149.439 104.058 149.361C104.447 149.219 104.751 149.023 104.971 148.772C105.209 148.528 105.377 148.232 105.477 147.884C105.581 147.547 105.636 147.172 105.64 146.759L105.678 145.233L97.9232 136.613Z" fill="#00A4FF"/>
<path d="M116.234 128.228C117.342 127.588 118.336 127.376 119.215 127.592C120.088 127.796 120.871 128.499 121.564 129.7L125.054 135.745L123.547 136.615L120.117 130.674C119.684 129.923 119.193 129.46 118.645 129.284C118.096 129.107 117.464 129.226 116.749 129.639C115.721 130.233 115.177 130.931 115.118 131.735C115.059 132.539 115.342 133.484 115.969 134.569L118.749 139.385L117.225 140.265L111.865 130.981L113.095 130.271L114.05 131.405L114.136 131.355C114.158 130.912 114.258 130.5 114.439 130.118C114.624 129.719 114.871 129.361 115.181 129.043C115.49 128.726 115.841 128.454 116.234 128.228Z" fill="#00A4FF"/>
<path d="M135.111 128.364C134.381 128.968 133.606 129.358 132.784 129.536C131.972 129.705 131.143 129.613 130.296 129.258C129.459 128.894 128.637 128.224 127.83 127.248C126.989 126.231 126.474 125.264 126.287 124.346C126.099 123.429 126.17 122.583 126.499 121.809C126.838 121.027 127.378 120.33 128.117 119.718C128.539 119.37 128.983 119.08 129.45 118.85C129.908 118.609 130.312 118.449 130.66 118.368L131.174 119.837C130.851 119.949 130.491 120.099 130.095 120.289C129.698 120.479 129.356 120.693 129.068 120.93C128.513 121.389 128.153 121.886 127.989 122.419C127.825 122.953 127.847 123.523 128.054 124.13C128.262 124.737 128.651 125.385 129.22 126.073C129.764 126.731 130.314 127.218 130.871 127.536C131.428 127.854 131.979 127.987 132.524 127.935C133.069 127.882 133.603 127.639 134.127 127.206C134.579 126.832 134.936 126.459 135.199 126.086C135.472 125.704 135.697 125.328 135.874 124.956L136.868 126.159C136.71 126.532 136.491 126.895 136.211 127.247C135.95 127.601 135.584 127.974 135.111 128.364Z" fill="#00A4FF"/>
</svg>

      </div>
      <div class="welcome">Welcome back</div>
      <div class="details">Please enter your details to sign in.</div>
      <hr>
      <form @submit.prevent>
        <input type="text" ref="usernameEl" placeholder="Enter your email or username" v-model="username">
        <input type="password" ref="passwordEl" placeholder="• • • • • • • • • • •" v-model="password">
        <button class="signin" @click="SignIn" ref="SignInButton">Sign in</button>
        <div class="signup-wrapper">Don't have an account? <RouterLink to="/signup"><button class="signup" ref="SignUpButton">Sign up</button></RouterLink></div>
      </form>
    </div>
  </div>

</template>

<style scoped>

 .login {
   background-color: #ffffff;
   height: 80dvh;
   width: 60dvw;
   border-radius: 30px;
   display: flex;
   flex-direction: column;
   align-items: center;
   justify-content: center;
 }

 .error{
   border: 2px solid red;
 }
 .login-wrapper {
   display: flex;
   justify-content: center;
   align-items: center;
   height: 100dvh;
 }
 .logo
 {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 15rem;
 }
 .welcome{
   font-size: 1.5rem;
   font-weight: bold;
   height: 2.5rem;
 }

 .details{
   color: #696969;
 }
 hr{
  width: 80%;
  margin-top: 5rem;
 }
 form{
  display: flex;
  flex-direction: column;
  margin-top: 3rem;
  gap: 2rem;
  width: 80%;
 }
 input{
  height: 2.5rem;
  font-size: 1rem;
  border-radius: 8px;
  padding-left: 10px;
  border: 2px solid #adadad;
 }

 .signin{
  height: 2.7rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1rem;
  letter-spacing: 1px;
  border-radius: 8px;
  border: none;
  background-color: #121212;
  color: white;
 }

 .signin:hover{
  background-color: #2c2a2a;
  transition: all .1s linear;
 }
 .signup-wrapper{
  display: flex;
  justify-content: center;
  color: #696969;
 }

 .signup{
  border: none;
  background-color: #fff;
  font-size: 1rem;
  margin-left: 5px;
  font-weight: bold;
  cursor: pointer;
 }

 @media screen and (max-width: 490px) {
    .login {
      font-size: .8rem;
      height: 60dvh;
    }
    .welcome{
      font-size: 1rem;
      height: 1.5rem
    }
    hr{
      margin-top: 2rem;
    }
    form{
      gap: 1rem;
      margin-top: 1rem;
    }
    .signup{
      font-size: .8rem;
    }
  }

</style>
